//uv.client.js
"use strict";(()=>{class EventEmitter{constructor(){this.events=new Map()}
on(event,listener){if(!this.events.has(event))this.events.set(event,new Set());this.events.get(event).add(listener);return this}
emit(event,...args){const listeners=this.events.get(event);if(!listeners)return!1;for(const listener of listeners){listener.apply(this,args)}
return!0}}
class HookEvent{#intercepted=!1;#returnValue=null;constructor(data={},target=null,that=null){this.data=data;this.target=target;this.that=that}
get intercepted(){return this.#intercepted}
get returnValue(){return this.#returnValue}
respondWith(value){this.#returnValue=value;this.#intercepted=!0}}
class BaseHook extends EventEmitter{constructor(ctx){super();this.ctx=ctx;this.window=ctx.window}}
class UVDocument extends BaseHook{constructor(ctx){super(ctx);this.document=this.window.document;this.Document=this.window.Document||{};this.DOMParser=this.window.DOMParser||{};this.docProto=this.Document.prototype||{};this.domProto=this.DOMParser.prototype||{};this.title=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"title");this.cookie=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"cookie");this.referrer=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"referrer");this.domain=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"domain");this.documentURI=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"documentURI");this.write=this.docProto.write;this.writeln=this.docProto.writeln;this.querySelector=this.docProto.querySelector;this.querySelectorAll=this.docProto.querySelectorAll;this.parseFromString=this.domProto.parseFromString;this.URL=ctx.nativeMethods.getOwnPropertyDescriptor(this.docProto,"URL")}
overrideParseFromString(){this.ctx.override(this.domProto,"parseFromString",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[string,type]=args;const event=new HookEvent({string,type},target,that);this.emit("parseFromString",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.string,event.data.type)})}
overrideQuerySelector(){this.ctx.override(this.docProto,"querySelector",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[selectors]=args;const event=new HookEvent({selectors},target,that);this.emit("querySelector",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.selectors)})}
overrideDomain(){this.ctx.overrideDescriptor(this.docProto,"domain",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getDomain",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);this.emit("setDomain",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.value)}})}
overrideReferrer(){this.ctx.overrideDescriptor(this.docProto,"referrer",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("referrer",event);return event.intercepted?event.returnValue:event.data.value}})}
overrideCreateTreeWalker(){this.ctx.override(this.docProto,"createTreeWalker",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[root,show=0xFFFFFFFF,filter,expandEntityReferences]=args;const event=new HookEvent({root,show,filter,expandEntityReferences},target,that);this.emit("createTreeWalker",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.root,event.data.show,event.data.filter,event.data.expandEntityReferences)})}
overrideWrite(){this.ctx.override(this.docProto,"write",(target,that,args)=>{if(!args.length)return target.apply(that,args);const event=new HookEvent({html:args},target,that);this.emit("write",event);return event.intercepted?event.returnValue:event.target.apply(event.that,event.data.html)});this.ctx.override(this.docProto,"writeln",(target,that,args)=>{if(!args.length)return target.apply(that,args);const event=new HookEvent({html:args},target,that);this.emit("writeln",event);return event.intercepted?event.returnValue:event.target.apply(event.that,event.data.html)})}
overrideDocumentURI(){this.ctx.overrideDescriptor(this.docProto,"documentURI",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("documentURI",event);return event.intercepted?event.returnValue:event.data.value}})}
overrideURL(){this.ctx.overrideDescriptor(this.docProto,"URL",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("url",event);return event.intercepted?event.returnValue:event.data.value}})}
overrideCookie(){this.ctx.overrideDescriptor(this.docProto,"cookie",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getCookie",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);this.emit("setCookie",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.value)}})}
overrideTitle(){this.ctx.overrideDescriptor(this.docProto,"title",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getTitle",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);this.emit("setTitle",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.value)}})}}
class UVElement extends BaseHook{constructor(ctx){super(ctx);this.Element=this.window.Element;this.elemProto=this.Element?this.Element.prototype:{};this.innerHTML=ctx.nativeMethods.getOwnPropertyDescriptor(this.elemProto,"innerHTML");this.outerHTML=ctx.nativeMethods.getOwnPropertyDescriptor(this.elemProto,"outerHTML");this.setAttribute=this.elemProto.setAttribute;this.getAttribute=this.elemProto.getAttribute;this.removeAttribute=this.elemProto.removeAttribute;this.hasAttribute=this.elemProto.hasAttribute;this.querySelector=this.elemProto.querySelector;this.querySelectorAll=this.elemProto.querySelectorAll;this.insertAdjacentHTML=this.elemProto.insertAdjacentHTML;this.insertAdjacentText=this.elemProto.insertAdjacentText}
overrideQuerySelector(){this.ctx.override(this.elemProto,"querySelector",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[selectors]=args;const event=new HookEvent({selectors},target,that);this.emit("querySelector",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.selectors)})}
overrideAttribute(){this.ctx.override(this.elemProto,"getAttribute",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[name]=args;const event=new HookEvent({name},target,that);this.emit("getAttribute",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name)});this.ctx.override(this.elemProto,"setAttribute",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[name,value]=args;const event=new HookEvent({name,value},target,that);this.emit("setAttribute",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name,event.data.value)});this.ctx.override(this.elemProto,"hasAttribute",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[name]=args;const event=new HookEvent({name},target,that);this.emit("hasAttribute",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name)});this.ctx.override(this.elemProto,"removeAttribute",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[name]=args;const event=new HookEvent({name},target,that);this.emit("removeAttribute",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name)})}
overrideAudio(){this.ctx.override(this.window,"Audio",(target,that,args)=>{if(!args.length)return new target(...args);const[url]=args;const event=new HookEvent({url},target,that);this.emit("audio",event);return event.intercepted?event.returnValue:new event.target(event.data.url)},!0)}
overrideHtml(){this.hookProperty(this.Element,"innerHTML",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getInnerHTML",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);if(this.emit("setInnerHTML",event),event.intercepted)return event.returnValue;target.call(that,event.data.value)}});this.hookProperty(this.Element,"outerHTML",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getOuterHTML",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);if(this.emit("setOuterHTML",event),event.intercepted)return event.returnValue;target.call(that,event.data.value)}})}
overrideInsertAdjacentHTML(){this.ctx.override(this.elemProto,"insertAdjacentHTML",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[position,html]=args;const event=new HookEvent({position,html},target,that);this.emit("insertAdjacentHTML",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.position,event.data.html)})}
overrideInsertAdjacentText(){this.ctx.override(this.elemProto,"insertAdjacentText",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[position,text]=args;const event=new HookEvent({position,text},target,that);this.emit("insertAdjacentText",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.position,event.data.text)})}
hookProperty(element,prop,descriptor){if(!element)return!1;if(this.ctx.nativeMethods.isArray(element)){for(const el of element)this.hookProperty(el,prop,descriptor);return!0}
this.ctx.overrideDescriptor(element.prototype,prop,descriptor);return!0}}
class UVNode extends BaseHook{constructor(ctx){super(ctx);this.Node=this.window.Node||{};this.nodeProto=this.Node.prototype||{};this.compareDocumentPosition=this.nodeProto.compareDocumentPosition;this.contains=this.nodeProto.contains;this.insertBefore=this.nodeProto.insertBefore;this.replaceChild=this.nodeProto.replaceChild;this.append=this.nodeProto.append;this.appendChild=this.nodeProto.appendChild;this.removeChild=this.nodeProto.removeChild;this.textContent=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"textContent");this.parentNode=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"parentNode");this.parentElement=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"parentElement");this.childNodes=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"childNodes");this.baseURI=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"baseURI");this.previousSibling=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"previousSibling");this.ownerDocument=ctx.nativeMethods.getOwnPropertyDescriptor(this.nodeProto,"ownerDocument")}
overrideTextContent(){this.ctx.overrideDescriptor(this.nodeProto,"textContent",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getTextContent",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);if(this.emit("setTextContent",event),event.intercepted)return event.returnValue;target.call(that,event.data.value)}})}
overrideAppend(){this.ctx.override(this.nodeProto,"append",(target,that,[...nodes])=>{const event=new HookEvent({nodes},target,that);this.emit("append",event);return event.intercepted?event.returnValue:event.target.call(event.that,...event.data.nodes)});this.ctx.override(this.nodeProto,"appendChild",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[node]=args;const event=new HookEvent({node},target,that);this.emit("appendChild",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.node)})}
overrideBaseURI(){this.ctx.overrideDescriptor(this.nodeProto,"baseURI",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("baseURI",event);return event.intercepted?event.returnValue:event.data.value}})}}
class UVAttribute extends BaseHook{constructor(ctx){super(ctx);this.Attr=this.window.Attr||{};this.attrProto=this.Attr.prototype||{};this.value=ctx.nativeMethods.getOwnPropertyDescriptor(this.attrProto,"value");this.name=ctx.nativeMethods.getOwnPropertyDescriptor(this.attrProto,"name");this.getNamedItem=this.attrProto.getNamedItem||null;this.setNamedItem=this.attrProto.setNamedItem||null;this.removeNamedItem=this.attrProto.removeNamedItem||null;this.getNamedItemNS=this.attrProto.getNamedItemNS||null;this.setNamedItemNS=this.attrProto.setNamedItemNS||null;this.removeNamedItemNS=this.attrProto.removeNamedItemNS||null;this.item=this.attrProto.item||null}
overrideNameValue(){this.ctx.overrideDescriptor(this.attrProto,"name",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("name",event);return event.intercepted?event.returnValue:event.data.value}});this.ctx.overrideDescriptor(this.attrProto,"value",{get:(target,that)=>{const event=new HookEvent({name:this.name.get.call(that),value:target.call(that)},target,that);this.emit("getValue",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({name:this.name.get.call(that),value},target,that);if(this.emit("setValue",event),event.intercepted)return event.returnValue;event.target.call(event.that,event.data.value)}})}}
class UVFunction extends BaseHook{constructor(ctx){super(ctx);this.Function=this.window.Function;this.fnProto=this.Function.prototype;this.toString=this.fnProto.toString;this.fnStrings=ctx.fnStrings;this.call=this.fnProto.call;this.apply=this.fnProto.apply;this.bind=this.fnProto.bind}
overrideFunction(){this.ctx.override(this.window,"Function",(target,that,args)=>{if(!args.length)return target.apply(that,args);const script=args[args.length-1];const fnArgs=args.slice(0,args.length-1);const event=new HookEvent({script,args:fnArgs},target,that);this.emit("function",event);return event.intercepted?event.returnValue:event.target.call(event.that,...event.data.args,event.data.script)},!0)}
overrideToString(){this.ctx.override(this.fnProto,"toString",(target,that)=>{const event=new HookEvent({fn:that},target,that);this.emit("toString",event);return event.intercepted?event.returnValue:event.target.call(event.data.fn)})}}
class UVObject extends BaseHook{constructor(ctx){super(ctx);this.Object=this.window.Object;this.getOwnPropertyDescriptors=this.Object.getOwnPropertyDescriptors;this.getOwnPropertyDescriptor=this.Object.getOwnPropertyDescriptor;this.getOwnPropertyNames=this.Object.getOwnPropertyNames}
overrideGetPropertyNames(){this.ctx.override(this.Object,"getOwnPropertyNames",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[obj]=args;const event=new HookEvent({names:target.call(that,obj)},target,that);this.emit("getOwnPropertyNames",event);return event.intercepted?event.returnValue:event.data.names})}
overrideGetOwnPropertyDescriptors(){this.ctx.override(this.Object,"getOwnPropertyDescriptors",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[obj]=args;const event=new HookEvent({descriptors:target.call(that,obj)},target,that);this.emit("getOwnPropertyDescriptors",event);return event.intercepted?event.returnValue:event.data.descriptors})}}
class UVFetch extends BaseHook{constructor(ctx){super(ctx);this.fetch=this.window.fetch;this.Request=this.window.Request;this.Response=this.window.Response;this.Headers=this.window.Headers;this.reqProto=this.Request?this.Request.prototype:{};this.resProto=this.Response?this.Response.prototype:{};this.headersProto=this.Headers?this.Headers.prototype:{};this.reqUrl=ctx.nativeMethods.getOwnPropertyDescriptor(this.reqProto,"url");this.resUrl=ctx.nativeMethods.getOwnPropertyDescriptor(this.resProto,"url");this.reqHeaders=ctx.nativeMethods.getOwnPropertyDescriptor(this.reqProto,"headers");this.resHeaders=ctx.nativeMethods.getOwnPropertyDescriptor(this.resProto,"headers")}
override(){this.overrideRequest();this.overrideUrl();this.overrideHeaders();return!0}
overrideRequest(){if(!this.fetch)return!1;this.ctx.override(this.window,"fetch",(target,that,args)=>{if(!args.length||args[0]instanceof this.Request)return target.apply(that,args);const[input,options={}]=args;const event=new HookEvent({input,options},target,that);this.emit("request",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.input,event.data.options)});this.ctx.override(this.window,"Request",(target,that,args)=>{if(!args.length)return new target(...args);const[input,options={}]=args;const event=new HookEvent({input,options},target);this.emit("request",event);return event.intercepted?event.returnValue:new event.target(event.data.input,event.data.options)},!0);return!0}
overrideUrl(){this.ctx.overrideDescriptor(this.reqProto,"url",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("requestUrl",event);return event.intercepted?event.returnValue:event.data.value}});this.ctx.overrideDescriptor(this.resProto,"url",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("responseUrl",event);return event.intercepted?event.returnValue:event.data.value}});return!0}
overrideHeaders(){if(!this.Headers)return!1;this.ctx.override(this.headersProto,"get",(target,that,[name])=>{if(!name)return target.call(that);const event=new HookEvent({name,value:target.call(that,name)},target,that);this.emit("getHeader",event);return event.intercepted?event.returnValue:event.data.value});return!0}}
class UVXHR extends BaseHook{constructor(ctx){super(ctx);this.XMLHttpRequest=this.window.XMLHttpRequest;this.xhrProto=this.window.XMLHttpRequest?this.window.XMLHttpRequest.prototype:{};this.open=this.xhrProto.open;this.abort=this.xhrProto.abort;this.send=this.xhrProto.send;this.overrideMimeType=this.xhrProto.overrideMimeType;this.getAllResponseHeaders=this.xhrProto.getAllResponseHeaders;this.getResponseHeader=this.xhrProto.getResponseHeader;this.setRequestHeader=this.xhrProto.setRequestHeader;this.responseURL=ctx.nativeMethods.getOwnPropertyDescriptor(this.xhrProto,"responseURL");this.responseText=ctx.nativeMethods.getOwnPropertyDescriptor(this.xhrProto,"responseText")}
override(){this.overrideOpen();this.overrideSend();this.overrideResponseUrl()}
overrideOpen(){this.ctx.override(this.xhrProto,"open",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[method,input,async=!0,user=null,password=null]=args;const event=new HookEvent({method,input,async,user,password},target,that);this.emit("open",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.method,event.data.input,event.data.async,event.data.user,event.data.password)})}
overrideResponseUrl(){this.ctx.overrideDescriptor(this.xhrProto,"responseURL",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("responseUrl",event);return event.intercepted?event.returnValue:event.data.value}})}
overrideSend(){this.ctx.override(this.xhrProto,"send",(target,that,[body=null])=>{const event=new HookEvent({body},target,that);this.emit("send",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.body)})}}
class UVEventSource extends BaseHook{constructor(ctx){super(ctx);this.EventSource=this.window.EventSource||{};this.esProto=this.EventSource.prototype||{};this.url=ctx.nativeMethods.getOwnPropertyDescriptor(this.esProto,"url");this.CONNECTING=0;this.OPEN=1;this.CLOSED=2}
overrideConstruct(){this.ctx.override(this.window,"EventSource",(target,that,args)=>{if(!args.length)return new target(...args);const[url,config={}]=args;const event=new HookEvent({url,config},target,that);this.emit("construct",event);return event.intercepted?event.returnValue:new event.target(event.data.url,event.data.config)},!0);if("EventSource" in this.window){this.window.EventSource.CONNECTING=this.CONNECTING;this.window.EventSource.OPEN=this.OPEN;this.window.EventSource.CLOSED=this.CLOSED}}
overrideUrl(){this.ctx.overrideDescriptor(this.esProto,"url",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("url",event);return event.data.value}})}}
class UVHistory extends BaseHook{constructor(ctx){super(ctx);this.History=this.window.History;this.history=this.window.history;this.historyProto=this.History?this.History.prototype:{};this.pushState=this.historyProto.pushState;this.replaceState=this.historyProto.replaceState}
override(){this.overridePushState();this.overrideReplaceState()}
overridePushState(){this.ctx.override(this.historyProto,"pushState",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[state,title,url=""]=args;const event=new HookEvent({state,title,url},target,that);this.emit("pushState",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.state,event.data.title,event.data.url)})}
overrideReplaceState(){this.ctx.override(this.historyProto,"replaceState",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[state,title,url=""]=args;const event=new HookEvent({state,title,url},target,that);this.emit("replaceState",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.state,event.data.title,event.data.url)})}}
class UVLocation extends BaseHook{constructor(ctx){super(ctx);this.location=this.window.location;this.WorkerLocation=this.ctx.worker?this.window.WorkerLocation:null;this.workerLocProto=this.WorkerLocation?this.WorkerLocation.prototype:{};this.keys=["href","protocol","host","hostname","port","pathname","search","hash","origin"];this.HashChangeEvent=this.window.HashChangeEvent||null;this.href=this.WorkerLocation?ctx.nativeMethods.getOwnPropertyDescriptor(this.workerLocProto,"href"):ctx.nativeMethods.getOwnPropertyDescriptor(this.location,"href")}
overrideWorkerLocation(rewriteUrl){if(!this.WorkerLocation)return!1;for(const key of this.keys){this.ctx.overrideDescriptor(this.workerLocProto,key,{get:()=>rewriteUrl(this.href.get.call(this.location))[key]})}
return!0}
emulate(sourceUrl,rewriteUrl){const emulated={};const that=this;for(const key of this.keys){this.ctx.nativeMethods.defineProperty(emulated,key,{get(){return sourceUrl(that.href.get.call(that.location))[key]},set:key!=="origin"?function(val){switch(key){case "href":that.location.href=rewriteUrl(val);break;case "hash":that.emit("hashchange",emulated.href,val.trim().startsWith("#")?new URL(val.trim(),emulated.href).href:new URL("#"+val.trim(),emulated.href).href,that);break;default:const url=new URL(emulated.href);url[key]=val;that.location.href=rewriteUrl(url.href);break}}:undefined,configurable:!1,enumerable:!0})}
if("reload" in this.location){this.ctx.nativeMethods.defineProperty(emulated,"reload",{value:this.ctx.wrap(this.location,"reload",(target,that)=>target.call(that===emulated?this.location:that)),writable:!1,enumerable:!0})}
if("replace" in this.location){this.ctx.nativeMethods.defineProperty(emulated,"replace",{value:this.ctx.wrap(this.location,"assign",(target,that,args)=>{if(!args.length||that!==emulated)target.call(that);const[url]=args;const newUrl=new URL(url,emulated.href);return target.call(that===emulated?this.location:that,rewriteUrl(newUrl.href))}),writable:!1,enumerable:!0})}
this.ctx.nativeMethods.defineProperty(emulated,"toString",{value:this.ctx.wrap(this.location,"toString",()=>emulated.href),enumerable:!0,writable:!1});this.ctx.nativeMethods.defineProperty(emulated,Symbol.toPrimitive,{value:()=>emulated.href,writable:!1,enumerable:!1});if(this.ctx.window.Location)this.ctx.nativeMethods.setPrototypeOf(emulated,this.ctx.window.Location.prototype);return emulated}}
class UVPostMessage extends BaseHook{constructor(ctx){super(ctx);this.postMessage=this.window.postMessage;this.MessageEvent=this.window.MessageEvent||{};this.messageProto=this.MessageEvent.prototype||{};this.messageData=ctx.nativeMethods.getOwnPropertyDescriptor(this.messageProto,"data");this.messageOrigin=ctx.nativeMethods.getOwnPropertyDescriptor(this.messageProto,"origin")}
overridePostMessage(){this.ctx.override(this.window,"postMessage",(target,that,args)=>{if(!args.length)return target.apply(that,args);let message,origin,transfer;if(this.ctx.worker){[message,transfer=[]]=args}else{[message,origin,transfer=[]]=args}
const event=new HookEvent({message,origin,transfer,worker:this.ctx.worker},target,that);this.emit("postMessage",event);return event.intercepted?event.returnValue:this.ctx.worker?event.target.call(event.that,event.data.message,event.data.transfer):event.target.call(event.that,event.data.message,event.data.origin,event.data.transfer)})}
overrideMessageOrigin(){this.ctx.overrideDescriptor(this.messageProto,"origin",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("origin",event);return event.intercepted?event.returnValue:event.data.value}})}
overrideMessageData(){this.ctx.overrideDescriptor(this.messageProto,"data",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("data",event);return event.intercepted?event.returnValue:event.data.value}})}}
class UVNavigator extends BaseHook{constructor(ctx){super(ctx);this.navigator=this.window.navigator;this.Navigator=this.window.Navigator||{};this.navProto=this.Navigator.prototype||{};this.sendBeacon=this.navProto.sendBeacon}
overrideSendBeacon(){this.ctx.override(this.navProto,"sendBeacon",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[url,data=""]=args;const event=new HookEvent({url,data},target,that);this.emit("sendBeacon",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.url,event.data.data)})}}
class UVWorker extends BaseHook{constructor(ctx){super(ctx);this.Worker=this.window.Worker||{};this.Worklet=this.window.Worklet||{};this.workletProto=this.Worklet.prototype||{};this.workerProto=this.Worker.prototype||{};this.postMessage=this.workerProto.postMessage;this.terminate=this.workerProto.terminate;this.addModule=this.workletProto.addModule}
overrideWorker(){this.ctx.override(this.window,"Worker",(target,that,args)=>{if(!args.length)return new target(...args);const[url,options={}]=args;const event=new HookEvent({url,options},target,that);this.emit("worker",event);return event.intercepted?event.returnValue:new event.target(event.data.url,event.data.options)},!0)}
overrideAddModule(){this.ctx.override(this.workletProto,"addModule",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[url,options={}]=args;const event=new HookEvent({url,options},target,that);this.emit("addModule",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.url,event.data.options)})}
overrideImportScripts(){this.ctx.override(this.window,"importScripts",(target,that,args)=>{if(!args.length)return target.apply(that,args);const event=new HookEvent({scripts:args},target,that);this.emit("importScripts",event);return event.intercepted?event.returnValue:event.target.apply(event.that,event.data.scripts)})}
overridePostMessage(){this.ctx.override(this.workerProto,"postMessage",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[message,transfer=[]]=args;const event=new HookEvent({message,transfer},target,that);this.emit("postMessage",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.message,event.data.transfer)})}}
class UVURL extends BaseHook{constructor(ctx){super(ctx);this.URL=this.window.URL||{};this.createObjectURL=this.URL.createObjectURL;this.revokeObjectURL=this.URL.revokeObjectURL}
overrideObjectURL(){this.ctx.override(this.URL,"createObjectURL",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[object]=args;const event=new HookEvent({object},target,that);this.emit("createObjectURL",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.object)});this.ctx.override(this.URL,"revokeObjectURL",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[url]=args;const event=new HookEvent({url},target,that);this.emit("revokeObjectURL",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.url)})}}
class UVStorage extends BaseHook{constructor(ctx){super(ctx);this.localStorage=this.window.localStorage||null;this.sessionStorage=this.window.sessionStorage||null;this.Storage=this.window.Storage||{};this.storeProto=this.Storage.prototype||{};this.wrappers=new ctx.nativeMethods.Map()}
overrideMethods(){this.ctx.override(this.storeProto,"getItem",(target,that,args)=>{if(!args.length)return target.apply(this.wrappers.get(that)||that,args);const[name]=args;const event=new HookEvent({name},target,this.wrappers.get(that)||that);this.emit("getItem",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name)});this.ctx.override(this.storeProto,"setItem",(target,that,args)=>{if(args.length<2)return target.apply(this.wrappers.get(that)||that,args);const[name,value]=args;const event=new HookEvent({name,value},target,this.wrappers.get(that)||that);this.emit("setItem",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name,event.data.value)});this.ctx.override(this.storeProto,"removeItem",(target,that,args)=>{if(!args.length)return target.apply(this.wrappers.get(that)||that,args);const[name]=args;const event=new HookEvent({name},target,this.wrappers.get(that)||that);this.emit("removeItem",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.name)});this.ctx.override(this.storeProto,"clear",(target,that)=>{const event=new HookEvent(null,target,this.wrappers.get(that)||that);this.emit("clear",event);return event.intercepted?event.returnValue:event.target.call(event.that)});this.ctx.override(this.storeProto,"key",(target,that,args)=>{if(!args.length)return target.apply(this.wrappers.get(that)||that,args);const[index]=args;const event=new HookEvent({index},target,this.wrappers.get(that)||that);this.emit("key",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.index)})}
overrideLength(){this.ctx.overrideDescriptor(this.storeProto,"length",{get:(target,that)=>{const event=new HookEvent({length:target.call(this.wrappers.get(that)||that)},target,this.wrappers.get(that)||that);this.emit("length",event);return event.intercepted?event.returnValue:event.data.length}})}
emulate(storage,storageObj={}){this.ctx.nativeMethods.setPrototypeOf(storageObj,this.storeProto);const proxy=new this.ctx.window.Proxy(storageObj,{get:(target,prop)=>{if(prop in this.storeProto||typeof prop==="symbol")return storage[prop];const event=new HookEvent({name:prop},null,storage);this.emit("get",event);return event.intercepted?event.returnValue:storage[event.data.name]},set:(target,prop,value)=>{if(prop in this.storeProto||typeof prop==="symbol")return(storage[prop]=value);const event=new HookEvent({name:prop,value},null,storage);this.emit("set",event);return event.intercepted?event.returnValue:(storage[event.data.name]=event.data.value)},deleteProperty:(target,prop)=>{if(typeof prop==="symbol")return delete storage[prop];const event=new HookEvent({name:prop},null,storage);this.emit("delete",event);return event.intercepted?event.returnValue:delete storage[event.data.name]}});this.wrappers.set(proxy,storage);this.ctx.nativeMethods.setPrototypeOf(proxy,this.storeProto);return proxy}}
class UVStyle extends BaseHook{constructor(ctx){super(ctx);this.CSSStyleDeclaration=this.window.CSSStyleDeclaration||{};this.cssStyleProto=this.CSSStyleDeclaration.prototype||{};this.getPropertyValue=this.cssStyleProto.getPropertyValue||null;this.setProperty=this.cssStyleProto.setProperty||null;this.urlProps=new Set(["background","backgroundImage","borderImage","borderImageSource","listStyle","listStyleImage","cursor"]);this.dashedUrlProps=new Set(["background","background-image","border-image","border-image-source","list-style","list-style-image","cursor"]);this.propToDashed={background:"background",backgroundImage:"background-image",borderImage:"border-image",borderImageSource:"border-image-source",listStyle:"list-style",listStyleImage:"list-style-image",cursor:"cursor"}}
overrideSetGetProperty(){this.ctx.override(this.cssStyleProto,"getPropertyValue",(target,that,args)=>{if(!args.length)return target.apply(that,args);const[property]=args;const event=new HookEvent({property},target,that);this.emit("getPropertyValue",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.property)});this.ctx.override(this.cssStyleProto,"setProperty",(target,that,args)=>{if(args.length<2)return target.apply(that,args);const[property,value]=args;const event=new HookEvent({property,value},target,that);this.emit("setProperty",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.property,event.data.value)})}
overrideCssText(){this.ctx.overrideDescriptor(this.cssStyleProto,"cssText",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("getCssText",event);return event.intercepted?event.returnValue:event.data.value},set:(target,that,[value])=>{const event=new HookEvent({value},target,that);this.emit("setCssText",event);return event.intercepted?event.returnValue:event.target.call(event.that,event.data.value)}})}}
class UVWebSocket extends BaseHook{constructor(ctx){super(ctx);this.WebSocket=this.window.WebSocket||{};this.wsProto=this.WebSocket.prototype||{};this.url=ctx.nativeMethods.getOwnPropertyDescriptor(this.wsProto,"url");this.protocol=ctx.nativeMethods.getOwnPropertyDescriptor(this.wsProto,"protocol");this.readyState=ctx.nativeMethods.getOwnPropertyDescriptor(this.wsProto,"readyState");this.send=this.wsProto.send}
overrideWebSocket(){this.ctx.override(this.window,"WebSocket",(target,that,args)=>{if(!args.length)return new target(...args);const event=new HookEvent({args},target,that);this.emit("websocket",event);return event.intercepted?event.returnValue:new event.target(event.data.url,event.data.protocols)},!0)}
overrideURL(){this.ctx.overrideDescriptor(this.wsProto,"url",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("url",event);return event.data.value}})}
overrideProtocol(){this.ctx.overrideDescriptor(this.wsProto,"protocol",{get:(target,that)=>{const event=new HookEvent({value:target.call(that)},target,that);this.emit("protocol",event);return event.data.value}})}}
class UVClient extends BaseHook{constructor(window=self,bareClient,worker=!window.window){super({window,nativeMethods:{fnToString:window.Function.prototype.toString,defineProperty:window.Object.defineProperty,getOwnPropertyDescriptor:window.Object.getOwnPropertyDescriptor,getOwnPropertyDescriptors:window.Object.getOwnPropertyDescriptors,getOwnPropertyNames:window.Object.getOwnPropertyNames,keys:window.Object.keys,getOwnPropertySymbols:window.Object.getOwnPropertySymbols,isArray:window.Array.isArray,setPrototypeOf:window.Object.setPrototypeOf,isExtensible:window.Object.isExtensible,Map:window.Map,Proxy:window.Proxy},worker});this.bareClient=bareClient;this.fetch=new UVFetch(this);this.xhr=new UVXHR(this);this.history=new UVHistory(this);this.element=new UVElement(this);this.node=new UVNode(this);this.document=new UVDocument(this);this.function=new UVFunction(this);this.object=new UVObject(this);this.websocket=new UVWebSocket(this);this.message=new UVPostMessage(this);this.navigator=new UVNavigator(this);this.eventSource=new UVEventSource(this);this.attribute=new UVAttribute(this);this.url=new UVURL(this);this.workers=new UVWorker(this);this.location=new UVLocation(this);this.storage=new UVStorage(this);this.style=new UVStyle(this)}
override(obj,prop,wrapper,construct=!1){const original=obj[prop];if(!original)return original;const wrapped=construct?{attach:function(...args){return wrapper(original,this,args)}}.attach:function(...args){return wrapper(original,this,args)};if(construct){wrapped.prototype=original.prototype;wrapped.prototype.constructor=wrapped}
this.emit("wrap",original,wrapped,construct);obj[prop]=wrapped;return wrapped}
overrideDescriptor(obj,prop,descriptor={}){const original=this.ctx.nativeMethods.getOwnPropertyDescriptor(obj,prop);if(!original)return!1;for(const key in descriptor){if(key in original){if(key==="get"||key==="set"){original[key]=this.wrap(original,key,descriptor[key])}else{original[key]=typeof descriptor[key]==="function"?descriptor[key](original[key]):descriptor[key]}}}
this.ctx.nativeMethods.defineProperty(obj,prop,original);return original}
wrap(obj,prop,handler,construct=!1){const original=obj[prop];if(!original)return original;const wrapped=construct?{attach:function(...args){return handler(original,this,args)}}.attach:function(...args){return handler(original,this,args)};if(construct){wrapped.prototype=original.prototype;wrapped.prototype.constructor=wrapped}
this.emit("wrap",original,wrapped,construct);return wrapped}}
if(typeof self==="object")self.UVClient=UVClient})()