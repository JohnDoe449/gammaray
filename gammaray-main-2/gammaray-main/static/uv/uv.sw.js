//uv.sw.js
importScripts('/uv/uv.bundle.js');importScripts('/uv/uv.config.js');importScripts('/uv/uv.handler.js');const DANGEROUS_TOKENS=['location','eval','parent','top','import','postMessage','self','window','document'];function needsRewrite(code){if(code.length<500)return!0;for(let i=0;i<DANGEROUS_TOKENS.length;i++){if(code.includes(DANGEROUS_TOKENS[i]))return!0}
return!1}
class EventEmitter{constructor(){this.events=new Map()}
on(event,listener){if(!this.events.has(event))this.events.set(event,new Set());this.events.get(event).add(listener);return this}
emit(event,...args){const listeners=this.events.get(event);if(!listeners)return!1;for(const listener of listeners)listener.apply(this,args);return!0}}
class UVServiceWorker extends EventEmitter{constructor(config=__uv$config){super();if(!config.bare)config.bare='/edu/';this.addresses=typeof config.bare==='string'?[new URL(config.bare,location)]:config.bare.map(str=>new URL(str,location));this.headers={csp:new Set(['cross-origin-embedder-policy','cross-origin-opener-policy','cross-origin-resource-policy','content-security-policy','content-security-policy-report-only','expect-ct','feature-policy','origin-isolation','strict-transport-security','upgrade-insecure-requests','x-content-type-options','x-download-options','x-frame-options','x-permitted-cross-domain-policies','x-powered-by','x-xss-protection']),forward:new Set(['accept-encoding','connection','content-length']),};this.method={empty:new Set(['GET','HEAD'])};this.statusCode={empty:new Set([204,304])};this.config=config}
async fetch({request}){if(!request.url.startsWith(location.origin+(this.config.prefix||'/service/'))){return fetch(request)}
try{const ultraviolet=new Ultraviolet(this.config);if(typeof this.config.construct==='function')this.config.construct(ultraviolet,'service');const db=await ultraviolet.cookie.db();ultraviolet.meta.origin=location.origin;ultraviolet.meta.base=ultraviolet.meta.url=new URL(ultraviolet.sourceUrl(request.url));const requestCtx=new RequestContext(request,this,ultraviolet,!this.method.empty.has(request.method.toUpperCase())?await request.blob():null);if(ultraviolet.meta.url.protocol==='blob:'){requestCtx.blob=!0;requestCtx.base=requestCtx.url=new URL(requestCtx.url.pathname)}
if(request.referrer&&request.referrer.startsWith(location.origin)){const referer=new URL(ultraviolet.sourceUrl(request.referrer));if(requestCtx.headers.origin||(ultraviolet.meta.url.origin!==referer.origin&&request.mode==='cors')){requestCtx.headers.origin=referer.origin}
requestCtx.headers.referer=referer.href}
const cookies=await ultraviolet.cookie.getCookies(db)||[];const cookieStr=ultraviolet.cookie.serialize(cookies,ultraviolet.meta,!1);if(cookieStr)requestCtx.headers.cookie=cookieStr;requestCtx.headers.Host=requestCtx.url.host;const reqEvent=new HookEvent(requestCtx,null,null);this.emit('request',reqEvent);if(reqEvent.intercepted)return reqEvent.returnValue;const response=await fetch(requestCtx.send);if(response.status===500)return Promise.reject('');const responseCtx=new ResponseContext(requestCtx,response,this);const resEvent=new HookEvent(responseCtx,null,null);this.emit('beforemod',resEvent);if(resEvent.intercepted)return resEvent.returnValue;for(const name of this.headers.csp){if(name in responseCtx.headers)delete responseCtx.headers[name]}
if(responseCtx.headers.location){responseCtx.headers.location=ultraviolet.rewriteUrl(responseCtx.headers.location)}
if(responseCtx.headers['set-cookie']){Promise.resolve(ultraviolet.cookie.setCookies(responseCtx.headers['set-cookie'],db,ultraviolet.meta)).then(()=>{self.clients.matchAll().then(clients=>{clients.forEach(client=>client.postMessage({msg:'updateCookies',url:ultraviolet.meta.url.href}))})});delete responseCtx.headers['set-cookie']}
if(responseCtx.body){switch(request.destination){case 'script':case 'worker':responseCtx.body=`if (!self.__uv && self.importScripts) importScripts('${__uv$config.bundle}', '${__uv$config.config}', '${__uv$config.handler}');\n`;const scriptContent=await response.text();if(needsRewrite(scriptContent)){responseCtx.body+=ultraviolet.js.rewrite(scriptContent)}else{responseCtx.body+=scriptContent}
break;case 'style':responseCtx.body=ultraviolet.rewriteCSS(await response.text());break;case 'iframe':case 'document':if(isHtml(ultraviolet.meta.url,responseCtx.headers['content-type']||'')){responseCtx.body=ultraviolet.rewriteHtml(await response.text(),{document:!0,injectHead:ultraviolet.createHtmlInject(this.config.handler,this.config.bundle,this.config.config,ultraviolet.cookie.serialize(cookies,ultraviolet.meta,!0),request.referrer)})}
break}}
if(request.destination==='image'){responseCtx.headers['cache-control']='public, max-age=86400'}
if(requestCtx.headers.accept==='text/event-stream'){responseCtx.headers['content-type']='text/event-stream'}
this.emit('response',resEvent);if(resEvent.intercepted)return resEvent.returnValue;return new Response(responseCtx.body,{headers:responseCtx.headers,status:responseCtx.status,statusText:responseCtx.statusText,})}catch(err){return new Response(err.toString(),{status:500})}}
getBarerResponse(response){const headers={};const raw=JSON.parse(response.headers.get('x-bare-headers')||'{}');for(const key in raw)headers[key.toLowerCase()]=raw[key];return{headers,status:+response.headers.get('x-bare-status'),statusText:response.headers.get('x-bare-status-text'),body:!this.statusCode.empty.has(+response.headers.get('x-bare-status'))?response.body:null,}}
get address(){return this.addresses[Math.floor(Math.random()*this.addresses.length)]}
static Ultraviolet=Ultraviolet}
self.UVServiceWorker=UVServiceWorker;class ResponseContext{constructor(request,response,worker){const{headers,status,statusText,body}=!request.blob?worker.getBarerResponse(response):{status:response.status,statusText:response.statusText,headers:Object.fromEntries([...response.headers.entries()]),body:response.body,};this.request=request;this.raw=response;this.ultraviolet=request.ultraviolet;this.headers=headers;this.status=status;this.statusText=statusText;this.body=body}
get url(){return this.request.url}
get base(){return this.request.base}
set base(val){this.request.base=val}}
class RequestContext{constructor(request,worker,ultraviolet,body=null){this.ultraviolet=ultraviolet;this.request=request;this.headers=Object.fromEntries([...request.headers.entries()]);this.method=request.method;this.forward=[...worker.headers.forward];this.address=worker.address;this.body=body||null;this.redirect=request.redirect;this.credentials='omit';this.mode=request.mode==='cors'?request.mode:'same-origin';this.blob=!1}
get send(){return new Request((!this.blob?this.address.href+'v1/':'blob:'+location.origin+this.url.pathname),{method:this.method,headers:{'x-bare-protocol':this.url.protocol,'x-bare-host':this.url.hostname,'x-bare-path':this.url.pathname+this.url.search,'x-bare-port':this.url.port||(this.url.protocol==='https:'?'443':'80'),'x-bare-headers':JSON.stringify(this.headers),'x-bare-forward-headers':JSON.stringify(this.forward),},redirect:this.redirect,credentials:this.credentials,mode:location.origin!==this.address.origin?'cors':this.mode,body:this.body})}
get url(){return this.ultraviolet.meta.url}
set url(val){this.ultraviolet.meta.url=val}
get base(){return this.ultraviolet.meta.base}
set base(val){this.ultraviolet.meta.base=val}}
class HookEvent{#intercepted=!1;#returnValue=null;constructor(data={},target=null,that=null){this.data=data;this.target=target;this.that=that}
get intercepted(){return this.#intercepted}
get returnValue(){return this.#returnValue}
respondWith(input){this.#returnValue=input;this.#intercepted=!0}}
function isHtml(url,contentType=''){return(Ultraviolet.mime.contentType((contentType||url.pathname))||'text/html').split(';')[0]==='text/html'}